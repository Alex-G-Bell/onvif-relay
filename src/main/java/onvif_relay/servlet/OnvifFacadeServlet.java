/**
 * @what A servlet for exposing Thrift services over HTTP.
 * 
 * TServlet expects to be invoked via"
 * 
 * 2) Via HTTP POST with the request body being url-safe base 64 JSON package thrift
 *    request, with result returned as JSON response
 *
 * This code is based heavily on
 * {@link com.facebook.thrift.server.TSimpleServer}.
 * {@link https://gist.github.com/pieceable/430784/8c38b0cb47e9667d2168e75e61540d03f0c11e9d}.
 * 
 * @author John Hartley - for Ericsson Mana Lab Discovery POC
 * 
 */

package onvif_relay.servlet;

import java.io.IOException;
import java.io.InputStream;
import java.net.URI;
import java.util.ArrayList;
import java.util.Collection;
import java.util.Enumeration;
import java.util.HashSet;
import java.util.Map;
import java.util.Set;

import org.apache.commons.io.IOUtils;
import org.apache.http.client.methods.CloseableHttpResponse;
import org.apache.http.client.methods.HttpPost;
import org.apache.http.client.utils.URIBuilder;
import org.apache.http.entity.InputStreamEntity;
import org.apache.http.impl.client.CloseableHttpClient;
import org.apache.http.impl.client.HttpClients;

import fence.util.ConfigurationData;
import jakarta.servlet.ServletException;
import jakarta.servlet.http.HttpServlet;
import jakarta.servlet.http.HttpServletRequest;
import jakarta.servlet.http.HttpServletResponse;
import jakarta.xml.soap.MessageFactory;
import jakarta.xml.soap.SOAPConstants;
import jakarta.xml.soap.SOAPMessage;

public class OnvifFacadeServlet extends HttpServlet {
  ConfigurationData confData; 
  private static final long serialVersionUID = 1L;
  private /* GENERATED by XSLT */ String[] DeviceOperations = {
		    "GetServices", 
		    "GetServiceCapabilities", 
		    "GetDeviceInformation", 
		    "SetSystemDateAndTime", 
		    "GetSystemDateAndTime", 
		    "SetSystemFactoryDefault", 
		    "UpgradeSystemFirmware", 
		    "SystemReboot", 
		    "RestoreSystem", 
		    "GetSystemBackup", 
		    "GetSystemLog", 
		    "GetSystemSupportInformation", 
		    "GetScopes", 
		    "SetScopes", 
		    "AddScopes", 
		    "RemoveScopes", 
		    "GetDiscoveryMode", 
		    "SetDiscoveryMode", 
		    "GetRemoteDiscoveryMode", 
		    "SetRemoteDiscoveryMode", 
		    "GetDPAddresses", 
		    "SetDPAddresses", 
		    "GetEndpointReference", 
		    "GetRemoteUser", 
		    "SetRemoteUser", 
		    "GetUsers", 
		    "CreateUsers", 
		    "DeleteUsers", 
		    "SetUser", 
		    "GetWsdlUrl", 
		    "GetPasswordComplexityOptions", 
		    "GetPasswordComplexityConfiguration", 
		    "SetPasswordComplexityConfiguration", 
		    "GetPasswordHistoryConfiguration", 
		    "SetPasswordHistoryConfiguration", 
		    "GetAuthFailureWarningOptions", 
		    "GetAuthFailureWarningConfiguration", 
		    "SetAuthFailureWarningConfiguration", 
		    "GetCapabilities", 
		    "GetHostname", 
		    "SetHostname", 
		    "SetHostnameFromDHCP", 
		    "GetDNS", 
		    "SetDNS", 
		    "GetNTP", 
		    "SetNTP", 
		    "GetDynamicDNS", 
		    "SetDynamicDNS", 
		    "GetNetworkInterfaces", 
		    "SetNetworkInterfaces", 
		    "GetNetworkProtocols", 
		    "SetNetworkProtocols", 
		    "GetNetworkDefaultGateway", 
		    "SetNetworkDefaultGateway", 
		    "GetZeroConfiguration", 
		    "SetZeroConfiguration", 
		    "GetIPAddressFilter", 
		    "SetIPAddressFilter", 
		    "AddIPAddressFilter", 
		    "RemoveIPAddressFilter", 
		    "GetAccessPolicy", 
		    "SetAccessPolicy", 
		    "GetRelayOutputs", 
		    "SetRelayOutputSettings", 
		    "SetRelayOutputState", 
		    "SendAuxiliaryCommand", 
		    "GetDot11Capabilities", 
		    "GetDot11Status", 
		    "ScanAvailableDot11Networks", 
		    "GetSystemUris", 
		    "StartFirmwareUpgrade", 
		    "StartSystemRestore", 
		    "GetStorageConfigurations", 
		    "CreateStorageConfiguration", 
		    "GetStorageConfiguration", 
		    "SetStorageConfiguration", 
		    "DeleteStorageConfiguration", 
		    "GetGeoLocation", 
		    "SetGeoLocation", 
		    "DeleteGeoLocation", 
		    "SetHashingAlgorithm", 
		    "CreateCertificate", 
		    "GetCertificates", 
		    "GetCertificatesStatus", 
		    "SetCertificatesStatus", 
		    "DeleteCertificates", 
		    "GetPkcs10Request", 
		    "LoadCertificates", 
		    "GetClientCertificateMode", 
		    "SetClientCertificateMode", 
		    "GetCACertificates", 
		    "LoadCertificateWithPrivateKey", 
		    "GetCertificateInformation", 
		    "LoadCACertificates", 
		    "CreateDot1XConfiguration", 
		    "SetDot1XConfiguration", 
		    "GetDot1XConfiguration", 
		    "GetDot1XConfigurations", 
		    "DeleteDot1XConfiguration" };
  private /* GENERATED by XSLT */ String[] MediaOperations = {
		    "GetServiceCapabilities", 
		    "GetVideoSources", 
		    "GetAudioSources", 
		    "GetAudioOutputs", 
		    "CreateProfile", 
		    "GetProfile", 
		    "GetProfiles", 
		    "AddVideoEncoderConfiguration", 
		    "RemoveVideoEncoderConfiguration", 
		    "AddVideoSourceConfiguration", 
		    "RemoveVideoSourceConfiguration", 
		    "AddAudioEncoderConfiguration", 
		    "RemoveAudioEncoderConfiguration", 
		    "AddAudioSourceConfiguration", 
		    "RemoveAudioSourceConfiguration", 
		    "AddPTZConfiguration", 
		    "RemovePTZConfiguration", 
		    "AddVideoAnalyticsConfiguration", 
		    "RemoveVideoAnalyticsConfiguration", 
		    "AddMetadataConfiguration", 
		    "RemoveMetadataConfiguration", 
		    "AddAudioOutputConfiguration", 
		    "RemoveAudioOutputConfiguration", 
		    "AddAudioDecoderConfiguration", 
		    "RemoveAudioDecoderConfiguration", 
		    "DeleteProfile", 
		    "GetVideoSourceConfigurations", 
		    "GetVideoEncoderConfigurations", 
		    "GetAudioSourceConfigurations", 
		    "GetAudioEncoderConfigurations", 
		    "GetVideoAnalyticsConfigurations", 
		    "GetMetadataConfigurations", 
		    "GetAudioOutputConfigurations", 
		    "GetAudioDecoderConfigurations", 
		    "GetVideoSourceConfiguration", 
		    "GetVideoEncoderConfiguration", 
		    "GetAudioSourceConfiguration", 
		    "GetAudioEncoderConfiguration", 
		    "GetVideoAnalyticsConfiguration", 
		    "GetMetadataConfiguration", 
		    "GetAudioOutputConfiguration", 
		    "GetAudioDecoderConfiguration", 
		    "GetCompatibleVideoEncoderConfigurations", 
		    "GetCompatibleVideoSourceConfigurations", 
		    "GetCompatibleAudioEncoderConfigurations", 
		    "GetCompatibleAudioSourceConfigurations", 
		    "GetCompatibleVideoAnalyticsConfigurations", 
		    "GetCompatibleMetadataConfigurations", 
		    "GetCompatibleAudioOutputConfigurations", 
		    "GetCompatibleAudioDecoderConfigurations", 
		    "SetVideoSourceConfiguration", 
		    "SetVideoEncoderConfiguration", 
		    "SetAudioSourceConfiguration", 
		    "SetAudioEncoderConfiguration", 
		    "SetVideoAnalyticsConfiguration", 
		    "SetMetadataConfiguration", 
		    "SetAudioOutputConfiguration", 
		    "SetAudioDecoderConfiguration", 
		    "GetVideoSourceConfigurationOptions", 
		    "GetVideoEncoderConfigurationOptions", 
		    "GetAudioSourceConfigurationOptions", 
		    "GetAudioEncoderConfigurationOptions", 
		    "GetMetadataConfigurationOptions", 
		    "GetAudioOutputConfigurationOptions", 
		    "GetAudioDecoderConfigurationOptions", 
		    "GetGuaranteedNumberOfVideoEncoderInstances", 
		    "GetStreamUri", 
		    "StartMulticastStreaming", 
		    "StopMulticastStreaming", 
		    "SetSynchronizationPoint", 
		    "GetSnapshotUri", 
		    "GetVideoSourceModes", 
		    "SetVideoSourceMode", 
		    "GetOSDs", 
		    "GetOSD", 
		    "GetOSDOptions", 
		    "SetOSD", 
		    "CreateOSD", 
		    "DeleteOSD"};
  private Set<String> DeviceOperation = new HashSet<>();
  private Set<String> MediaOperation = new HashSet<>();

  private final Collection<Map.Entry<String, String>> customHeaders;
  
  public OnvifFacadeServlet(ConfigurationData cf) {
	super();
	confData = cf;
    this.customHeaders = new ArrayList<Map.Entry<String, String>>();
    for (String s: DeviceOperations) DeviceOperation.add(s);
    for (String s: MediaOperations) MediaOperation.add(s);
  }
   
  @Override
  public void init() throws ServletException {
    System.out.println("DBG>> DeviceDiscoveryServlet:init");  
  }
  
  @Override
  protected void doPost(HttpServletRequest request, HttpServletResponse response)
            throws IOException, ServletException {
	// String srvPort = confData.getItem("onvif-device", "port");
    String dport = confData.getItem("onvif-device", "device-port");
	String mport = confData.getItem("onvif-device", "media-port");
	String devrequest = confData.getItem("onvif-device", "device-service");
	String medrequest = confData.getItem("onvif-device", "media-service");  
	String reqURL;
	
	try {
		
	  InputStream is = request.getInputStream();
	  SOAPMessage soapReq = MessageFactory.newInstance(SOAPConstants.SOAP_1_2_PROTOCOL).createMessage(null, is);
	  
	  String soapMethod = soapReq.getSOAPBody().getChildNodes().item(1).getLocalName();
	  
	  if (DeviceOperation.contains(soapMethod)  || (! MediaOperation.contains(soapMethod))) {
	    reqURL = "http://127.0.0.1:" + dport + devrequest;
	    // RequestDispatcher dispatcher = request.getRequestDispatcher(devrequest);
	    // dispatcher.forward(request, response);
	  } else {
		reqURL = "http://127/0.0.1:" + mport + medrequest;
		// RequestDispatcher dispatcher = request.getRequestDispatcher(medrequest);
		// dispatcher.forward(request, response);
	  }
	  
	  URI uri = new URIBuilder(reqURL).build();
		  
	  HttpPost httpPost = new HttpPost(uri);

      InputStreamEntity entity = new InputStreamEntity(request.getInputStream());
	  httpPost.setEntity(entity);
	  
	  for (Enumeration<String> nxt = request.getHeaderNames(); nxt.hasMoreElements(); ) {
	      String hdr = nxt.nextElement();
		  httpPost.addHeader(hdr, request.getHeader(hdr));
	  }
      
  	  CloseableHttpClient client = HttpClients.createDefault();
	  CloseableHttpResponse onvifResponse = client.execute(httpPost);

	  IOUtils.copy(onvifResponse.getEntity().getContent(), response.getOutputStream());
	  
	  int responseCode = onvifResponse.getStatusLine().getStatusCode();
	  // response.setStatus(onvifResponse.getStatusLine().getStatusCode());
	  
	 
	} catch (Exception ex) {
	  // TODO Auto-generated catch block
	  ex.printStackTrace(); 
	}	  
  }
  
  @Override
  protected void doOptions(HttpServletRequest req, HttpServletResponse resp)
            throws IOException, ServletException {  
    resp.setHeader("Allow", "POST, OPTIONS");
  }

}
